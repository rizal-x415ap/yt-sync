<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>YouTube Sync Global (Final)</title>
<style>
  body { background:#111; color:#fff; font-family:Arial; text-align:center; padding:20px; }
  input,button { padding:8px; border:none; border-radius:6px; margin:5px; }
  input { width:60%; }
  button { background:#e50914; color:#fff; cursor:pointer; }
  button:hover { background:#ff4040; }
  iframe { width:80%; height:450px; border-radius:12px; margin-top:15px; }
  .controls { margin-top:10px; }
</style>
</head>
<body>

<h2>üé• YouTube Watch Together</h2>
<p>Tonton video YouTube bersama dengan waktu & aksi yang sama antar semua pengguna!</p>

<!-- Input URL -->
<div>
  <input type="text" id="videoUrl" placeholder="Tempel URL YouTube (misal: https://www.youtube.com/watch?v=xxxx)">
  <button id="loadBtn">Muat Video</button>
</div>

<!-- YouTube Player -->
<div id="player"></div>

<!-- Kontrol -->
<div class="controls">
  <button id="playBtn">‚ñ∂Ô∏è Putar</button>
  <button id="pauseBtn">‚è∏Ô∏è Jeda</button>
  <button id="syncBtn">üîÅ Sinkronkan</button>
</div>

<p id="status">Menunggu koneksi Firebase...</p>

<!-- üî• Firebase compat SDK -->
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database-compat.js"></script>

<script>
// üî• Konfigurasi Firebase kamu di sini
const firebaseConfig = {
  apiKey: "AIzaSyCLxcs6175tCztYpCGK4RSQu6OWYtXzFig",
    authDomain: "yt-sync-24cc1.firebaseapp.com",
    databaseURL: "https://yt-sync-24cc1-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "yt-sync-24cc1",
    storageBucket: "yt-sync-24cc1.firebasestorage.app",
    messagingSenderId: "595148556839",
    appId: "1:595148556839:web:2d470c580b49b98e389c02",
    measurementId: "G-X9FPENGD5R"
};

// üîå Inisialisasi Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const syncRef = db.ref("ytSync");

let player;
let currentVideoId = null;
let isLeader = false;

// üîπ Tambahkan script YouTube API
let tag = document.createElement('script');
tag.src = "https://www.youtube.com/iframe_api";
document.body.appendChild(tag);

function extractVideoID(url) {
  const match = url.match(/(?:v=|\.be\/)([^&#]+)/);
  return match ? match[1] : null;
}

// üîπ Dipanggil otomatis ketika API siap
function onYouTubeIframeAPIReady() {
  console.log("YouTube API siap digunakan ‚úÖ");
  document.getElementById("status").innerText = "Koneksi Firebase berhasil. Siap memuat video.";
}

// üîπ Muat video dari input
function loadVideo() {
  const url = document.getElementById('videoUrl').value.trim();
  const id = extractVideoID(url);
  if (!id) {
    alert("URL tidak valid! Pastikan formatnya seperti: https://www.youtube.com/watch?v=xxxx");
    return;
  }

  currentVideoId = id;
  if (player) player.destroy();

  player = new YT.Player('player', {
    videoId: id,
    playerVars: { 'controls': 1 },
    events: { 'onReady': onPlayerReady, 'onStateChange': onPlayerStateChange }
  });

  isLeader = true;
  syncRef.update({ videoId: id });
}

// üîπ Ketika video siap
function onPlayerReady() {
  document.getElementById('status').innerText = "Video siap diputar.";
}

// üîπ Ketika ada perubahan status video
function onPlayerStateChange(e) {
  if (!isLeader) return;
  const time = player.getCurrentTime();
  if (e.data === YT.PlayerState.PLAYING) {
    syncRef.update({ action: 'play', time });
  } else if (e.data === YT.PlayerState.PAUSED) {
    syncRef.update({ action: 'pause', time });
  }
}

// üîπ Tombol kontrol
function playVideo() {
  if (player && isLeader) {
    player.playVideo();
    syncRef.update({ action: 'play', time: player.getCurrentTime() });
  }
}
function pauseVideo() {
  if (player && isLeader) {
    player.pauseVideo();
    syncRef.update({ action: 'pause', time: player.getCurrentTime() });
  }
}
function syncNow() {
  if (player && isLeader) {
    syncRef.update({ action: 'sync', time: player.getCurrentTime() });
  }
}

// üîπ Listener global dari Firebase
syncRef.on('value', snap => {
  const data = snap.val();
  if (!data) return;

  // Muat video jika beda
  if (data.videoId && (!player || data.videoId !== currentVideoId)) {
    currentVideoId = data.videoId;
    player = new YT.Player('player', {
      videoId: data.videoId,
      playerVars: { 'controls': 1 },
      events: { 'onReady': onPlayerReady }
    });
  }

  if (!player || isLeader) return;

  if (data.action === 'play') {
    player.seekTo(data.time, true);
    player.playVideo();
  } else if (data.action === 'pause') {
    player.seekTo(data.time, true);
    player.pauseVideo();
  } else if (data.action === 'sync') {
    player.seekTo(data.time, true);
  }

  document.getElementById('status').innerText =
    "Disinkronkan ke waktu: " + (data.time || 0).toFixed(2) + " detik";
});

// üîπ Pasang event listener tombol
document.getElementById('loadBtn').addEventListener('click', loadVideo);
document.getElementById('playBtn').addEventListener('click', playVideo);
document.getElementById('pauseBtn').addEventListener('click', pauseVideo);
document.getElementById('syncBtn').addEventListener('click', syncNow);
</script>
</body>
</html>

