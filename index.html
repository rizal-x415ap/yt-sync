<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>YouTube Sync Global</title>
<style>
  body { background:#111; color:#fff; font-family:Arial, sans-serif; text-align:center; padding:20px; }
  input,button { padding:8px; border:none; border-radius:6px; margin:5px; }
  input { width:60%; max-width:500px; }
  button { background:#e50914; color:#fff; cursor:pointer; transition:.2s; }
  button:hover { background:#ff4040; }
  iframe { width:80%; max-width:800px; height:450px; border-radius:12px; margin-top:15px; border:none; }
  .controls { margin-top:10px; }
  #status { margin-top:15px; font-size:.95rem; color:#ccc; }
</style>
</head>
<body>

<h2>üé• YouTube Watch Together</h2>
<p>Tonton video YouTube bersama dengan waktu & aksi yang sama antar semua pengguna!</p>

<!-- Input URL -->
<div>
  <input type="text" id="videoUrl" placeholder="Tempel URL YouTube (misal: https://www.youtube.com/watch?v=xxxx)">
  <button id="loadBtn">Muat Video</button>
</div>

<!-- YouTube Player -->
<div id="player"></div>

<!-- Kontrol -->
<div class="controls">
  <button id="playBtn">‚ñ∂Ô∏è Putar</button>
  <button id="pauseBtn">‚è∏Ô∏è Jeda</button>
  <button id="syncBtn">üîÅ Sinkronkan</button>
</div>

<p id="status">‚è≥ Menunggu koneksi Firebase...</p>

<!-- üî• Firebase compat SDK (pastikan gunakan versi compat agar tidak error "export") -->
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database-compat.js"></script>

<script>
/* ======================= üî• KONFIGURASI FIREBASE ======================= */
const firebaseConfig = {
  apiKey: "AIzaSyCLxcs6175tCztYpCGK4RSQu6OWYtXzFig",
  authDomain: "yt-sync-24cc1.firebaseapp.com",
  databaseURL: "https://yt-sync-24cc1-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "yt-sync-24cc1",
  storageBucket: "yt-sync-24cc1.appspot.com", // üîß perbaikan: .app diganti ke .appspot.com (format resmi)
  messagingSenderId: "595148556839",
  appId: "1:595148556839:web:2d470c580b49b98e389c02",
  measurementId: "G-X9FPENGD5R"
};

/* ======================= üîå INISIALISASI FIREBASE ======================= */
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const syncRef = db.ref("ytSync");

let player;
let currentVideoId = null;
let isLeader = false;
let ytApiReady = false;

/* ======================= üé¨ LOAD YOUTUBE API ======================= */
(function loadYouTubeAPI() {
  const tag = document.createElement('script');
  tag.src = "https://www.youtube.com/iframe_api";
  document.body.appendChild(tag);
})();

/* ======================= üîç UTIL: AMBIL ID VIDEO ======================= */
function extractVideoID(url) {
  const match = url.match(/(?:v=|\.be\/)([^&#]+)/);
  return match ? match[1] : null;
}

/* ======================= ‚úÖ CALLBACK: API SIAP ======================= */
function onYouTubeIframeAPIReady() {
  ytApiReady = true;
  console.log("‚úÖ YouTube API siap digunakan");
  document.getElementById("status").innerText = "‚úÖ Firebase & YouTube API siap digunakan.";
}

/* ======================= üöÄ MUAT VIDEO ======================= */
function loadVideo() {
  const url = document.getElementById('videoUrl').value.trim();
  const id = extractVideoID(url);
  if (!id) return alert("URL tidak valid! Gunakan format: https://www.youtube.com/watch?v=xxxx");

  if (!ytApiReady) return alert("API YouTube belum siap, tunggu beberapa detik...");

  currentVideoId = id;
  isLeader = true;

  // Jika sudah ada player sebelumnya, hancurkan dulu
  if (player && player.destroy) player.destroy();

  player = new YT.Player('player', {
    videoId: id,
    playerVars: { 'controls': 1, 'rel': 0 },
    events: { 'onReady': onPlayerReady, 'onStateChange': onPlayerStateChange }
  });

  syncRef.update({ videoId: id, action: 'pause', time: 0 });
}

/* ======================= üü¢ SAAT VIDEO SIAP ======================= */
function onPlayerReady() {
  document.getElementById('status').innerText = "üé¨ Video siap diputar.";
}

/* ======================= üéû SAAT STATUS BERUBAH ======================= */
function onPlayerStateChange(e) {
  if (!isLeader || !player) return;
  const time = player.getCurrentTime();
  if (e.data === YT.PlayerState.PLAYING) {
    syncRef.update({ action: 'play', time });
  } else if (e.data === YT.PlayerState.PAUSED) {
    syncRef.update({ action: 'pause', time });
  }
}

/* ======================= üß≠ KONTROL PLAYER ======================= */
function playVideo() {
  if (player && isLeader) {
    player.playVideo();
    syncRef.update({ action: 'play', time: player.getCurrentTime() });
  }
}
function pauseVideo() {
  if (player && isLeader) {
    player.pauseVideo();
    syncRef.update({ action: 'pause', time: player.getCurrentTime() });
  }
}
function syncNow() {
  if (player && isLeader) {
    syncRef.update({ action: 'sync', time: player.getCurrentTime() });
  }
}

/* ======================= üåç LISTENER FIREBASE (REALTIME SYNC) ======================= */
syncRef.on('value', snap => {
  const data = snap.val();
  if (!data) return;

  // Jika videoId baru muncul ‚Üí buat player baru
  if (data.videoId && (!player || data.videoId !== currentVideoId)) {
    currentVideoId = data.videoId;
    player = new YT.Player('player', {
      videoId: data.videoId,
      playerVars: { 'controls': 1, 'rel': 0 },
      events: { 'onReady': onPlayerReady }
    });
  }

  // Jangan eksekusi sinkronisasi kalau kita adalah leader
  if (!player || isLeader) return;

  // Sinkronisasi aksi global
  if (data.action === 'play') {
    player.seekTo(data.time || 0, true);
    player.playVideo();
  } else if (data.action === 'pause') {
    player.seekTo(data.time || 0, true);
    player.pauseVideo();
  } else if (data.action === 'sync') {
    player.seekTo(data.time || 0, true);
  }

  document.getElementById('status').innerText =
    `üîÅ Disinkronkan ke waktu: ${parseFloat(data.time || 0).toFixed(2)} detik`;
});

/* ======================= ‚öôÔ∏è PASANG EVENT LISTENER ======================= */
document.getElementById('loadBtn').addEventListener('click', loadVideo);
document.getElementById('playBtn').addEventListener('click', playVideo);
document.getElementById('pauseBtn').addEventListener('click', pauseVideo);
document.getElementById('syncBtn').addEventListener('click', syncNow);

// Optional: cegah error tombol diklik sebelum API siap
['loadBtn', 'playBtn', 'pauseBtn', 'syncBtn'].forEach(id => {
  document.getElementById(id).disabled = true;
});
setTimeout(() => {
  ['loadBtn', 'playBtn', 'pauseBtn', 'syncBtn'].forEach(id => {
    document.getElementById(id).disabled = false;
  });
  document.getElementById('status').innerText = "‚úÖ Aplikasi siap digunakan!";
}, 2000);
</script>

</body>
</html>
